# BEVFusion with DETR Configuration
# 集成DETR的BEVFusion配置文件

# 继承基础配置
_base_:
  - ../default.yaml

# 点云范围
point_cloud_range: [-54.0, -54.0, -5.0, 54.0, 54.0, 3.0]

# 体素大小
voxel_size: [0.075, 0.075, 0.2]

# 图像尺寸
image_size: [256, 704]

# BEV特征尺寸
bev_h: 180
bev_w: 180

# 类别数
num_classes: 10

# 模型配置
model:
  type: BEVFusionDETR  # 使用集成DETR的BEVFusion
  
  extract_bev_feat: true  # 开启BEV特征提取
  
  # ========== 编码器配置 ==========
  encoders:
    # Camera分支
    camera:
      backbone:
        type: SwinTransformer
        embed_dims: 96
        depths: [2, 2, 6, 2]
        num_heads: [3, 6, 12, 24]
        window_size: 7
        mlp_ratio: 4
        qkv_bias: true
        qk_scale: null
        drop_rate: 0.
        attn_drop_rate: 0.
        drop_path_rate: 0.2
        patch_norm: true
        out_indices: [1, 2, 3]
        with_cp: false
        convert_weights: true
        init_cfg:
          type: Pretrained
          checkpoint: https://github.com/SwinTransformer/storage/releases/download/v1.0.0/swin_tiny_patch4_window7_224.pth
      
      neck:
        type: GeneralizedLSSFPN
        in_channels: [192, 384, 768]
        out_channels: 256
        start_level: 0
        num_outs: 3
        norm_cfg:
          type: BN2d
          requires_grad: true
        act_cfg:
          type: ReLU
          inplace: true
        upsample_cfg:
          mode: bilinear
          align_corners: false
      
      vtransform:
        type: DepthLSSTransform
        in_channels: 256
        out_channels: 80
        image_size: ${image_size}
        feature_size: [${int:${image_size[0]} / 8}, ${int:${image_size[1]} / 8}]
        xbound: [-54.0, 54.0, 0.6]
        ybound: [-54.0, 54.0, 0.6]
        zbound: [-10.0, 10.0, 20.0]
        dbound: [1.0, 60.0, 0.5]
        downsample: 2
    
    # LiDAR分支
    lidar:
      voxelize:
        max_num_points: 10
        point_cloud_range: ${point_cloud_range}
        voxel_size: ${voxel_size}
        max_voxels: [120000, 160000]
      
      backbone:
        type: SparseEncoder
        in_channels: 5
        sparse_shape: [1440, 1440, 41]
        output_channels: 128
        order:
          - conv
          - norm
          - act
        encoder_channels:
          - [16, 16, 32]
          - [32, 32, 64]
          - [64, 64, 128]
          - [128, 128]
        encoder_paddings:
          - [0, 0, 1]
          - [0, 0, 1]
          - [0, 0, [1, 1, 0]]
          - [0, 0]
        block_type: basicblock
  
  # ========== 融合器配置 ==========
  fuser:
    type: ConvFuser
    in_channels: [80, 256]
    out_channels: 256
  
  # ========== 解码器配置 ==========
  decoder:
    backbone:
      type: SECOND
      in_channels: 256
      out_channels: [128, 256]
      layer_nums: [5, 5]
      layer_strides: [1, 2]
      norm_cfg:
        type: BN
        eps: 1.0e-3
        momentum: 0.01
      conv_cfg:
        type: Conv2d
        bias: false
    
    neck:
      type: SECONDFPN
      in_channels: [128, 256]
      out_channels: [256, 256]
      upsample_strides: [1, 2]
      norm_cfg:
        type: BN
        eps: 1.0e-3
        momentum: 0.01
      upsample_cfg:
        type: deconv
        bias: false
      use_conv_for_no_stride: true
  
  # ========== BEV特征提取器配置 ==========
  bev_extractor:
    type: BEVFeatureExtractor
    in_channels: 512  # decoder neck输出通道数总和
    out_channels: 256
    num_layers: 3
    feat_h: ${bev_h}
    feat_w: ${bev_w}
    use_position_encoding: true
    norm_cfg:
      type: BN2d
    act_cfg:
      type: ReLU
  
  # ========== 检测头配置 ==========
  heads:
    object:
      type: DETRHead3D
      num_classes: ${num_classes}
      in_channels: 256
      num_query: 900  # 查询数量
      num_reg_fcs: 2
      
      transformer:
        type: DeformableDetrTransformer
        num_layers: 6
        num_heads: 8
        ffn_dim: 2048
        dropout: 0.1
      
      with_box_refine: true
      
      loss_cls:
        type: FocalLoss
        use_sigmoid: true
        gamma: 2.0
        alpha: 0.25
        loss_weight: 2.0
      
      loss_bbox:
        type: L1Loss
        loss_weight: 0.25
      
      loss_iou:
        type: GIoULoss
        loss_weight: 0.0
    
    # Map分割头（可选）
    map: null

# 损失权重
loss_scale:
  object: 1.0
  map: 1.0

# ========== 数据配置 ==========
data_root: data/nuscenes/
data_prefix:
  sweeps: sweeps
  samples: samples

# 训练配置
optimizer:
  type: AdamW
  lr: 2.0e-4
  weight_decay: 0.01
  paramwise_cfg:
    custom_keys:
      absolute_pos_embed:
        decay_mult: 0
      relative_position_bias_table:
        decay_mult: 0

optimizer_config:
  grad_clip:
    max_norm: 35
    norm_type: 2

lr_config:
  policy: CosineAnnealing
  warmup: linear
  warmup_iters: 500
  warmup_ratio: 0.33333333
  min_lr_ratio: 1.0e-3

momentum_config: null

# 训练周期
max_epochs: 20
evaluation:
  interval: 1

# Checkpoint配置
checkpoint_config:
  interval: 1
  max_keep_ckpts: 5

# 日志配置
log_config:
  interval: 50
  hooks:
    - type: TextLoggerHook
    - type: TensorboardLoggerHook

# Runtime配置
runner:
  type: CustomEpochBasedRunner
  max_epochs: ${max_epochs}

# 分布式训练
dist_params:
  backend: nccl

# 工作目录
work_dir: work_dirs/bevfusion_detr

# 随机种子
seed: 0
deterministic: false

# GPU设置
gpu_ids: [0]
