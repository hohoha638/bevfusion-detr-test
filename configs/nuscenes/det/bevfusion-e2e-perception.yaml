# BEVFusion End-to-End Multi-Task Perception Configuration
# 完整的端到端多任务感知配置

# 继承基础配置
_base_:
  - ../default.yaml

# 点云范围
point_cloud_range: [-54.0, -54.0, -5.0, 54.0, 54.0, 3.0]

# 体素大小
voxel_size: [0.075, 0.075, 0.2]

# 图像尺寸
image_size: [256, 704]

# BEV特征尺寸
bev_h: 180
bev_w: 180

# 类别配置
num_classes: 10  # 检测类别数
num_seg_classes: 4  # 分割类别数: 可行驶区域、车道线、人行道、其他

# ========================================
# 模型配置
# ========================================
model:
  type: BEVFusionE2E  # 端到端多任务模型
  
  extract_bev_feat: true
  enable_tracking: true  # 启用跟踪
  
  # 任务权重
  task_weights:
    detection: 1.0      # 检测任务权重
    segmentation: 1.0   # 分割任务权重
    tracking: 0.5       # 跟踪任务权重
  
  # ========== 编码器配置 ==========
  encoders:
    # Camera分支
    camera:
      backbone:
        type: SwinTransformer
        embed_dims: 96
        depths: [2, 2, 6, 2]
        num_heads: [3, 6, 12, 24]
        window_size: 7
        mlp_ratio: 4
        qkv_bias: true
        qk_scale: null
        drop_rate: 0.
        attn_drop_rate: 0.
        drop_path_rate: 0.2
        patch_norm: true
        out_indices: [1, 2, 3]
        with_cp: false
        convert_weights: true
        init_cfg:
          type: Pretrained
          checkpoint: https://github.com/SwinTransformer/storage/releases/download/v1.0.0/swin_tiny_patch4_window7_224.pth
      
      neck:
        type: GeneralizedLSSFPN
        in_channels: [192, 384, 768]
        out_channels: 256
        start_level: 0
        num_outs: 3
        norm_cfg:
          type: BN2d
          requires_grad: true
        act_cfg:
          type: ReLU
          inplace: true
        upsample_cfg:
          mode: bilinear
          align_corners: false
      
      vtransform:
        type: DepthLSSTransform
        in_channels: 256
        out_channels: 80
        image_size: ${image_size}
        feature_size: [${int:${image_size[0]} / 8}, ${int:${image_size[1]} / 8}]
        xbound: [-54.0, 54.0, 0.6]
        ybound: [-54.0, 54.0, 0.6]
        zbound: [-10.0, 10.0, 20.0]
        dbound: [1.0, 60.0, 0.5]
        downsample: 2
    
    # LiDAR分支
    lidar:
      voxelize:
        max_num_points: 10
        point_cloud_range: ${point_cloud_range}
        voxel_size: ${voxel_size}
        max_voxels: [120000, 160000]
      
      backbone:
        type: SparseEncoder
        in_channels: 5
        sparse_shape: [1440, 1440, 41]
        output_channels: 128
        order:
          - conv
          - norm
          - act
        encoder_channels:
          - [16, 16, 32]
          - [32, 32, 64]
          - [64, 64, 128]
          - [128, 128]
        encoder_paddings:
          - [0, 0, 1]
          - [0, 0, 1]
          - [0, 0, [1, 1, 0]]
          - [0, 0]
        block_type: basicblock
  
  # ========== 融合器配置 ==========
  fuser:
    type: ConvFuser
    in_channels: [80, 256]
    out_channels: 256
  
  # ========== 解码器配置 ==========
  decoder:
    backbone:
      type: SECOND
      in_channels: 256
      out_channels: [128, 256]
      layer_nums: [5, 5]
      layer_strides: [1, 2]
      norm_cfg:
        type: BN
        eps: 1.0e-3
        momentum: 0.01
      conv_cfg:
        type: Conv2d
        bias: false
    
    neck:
      type: SECONDFPN
      in_channels: [128, 256]
      out_channels: [256, 256]
      upsample_strides: [1, 2]
      norm_cfg:
        type: BN
        eps: 1.0e-3
        momentum: 0.01
      upsample_cfg:
        type: deconv
        bias: false
      use_conv_for_no_stride: true
  
  # ========== BEV特征提取器配置 ==========
  bev_extractor:
    type: BEVFeatureExtractor
    in_channels: 512
    out_channels: 256
    num_layers: 3
    feat_h: ${bev_h}
    feat_w: ${bev_w}
    use_position_encoding: true
    norm_cfg:
      type: BN2d
    act_cfg:
      type: ReLU
  
  # ========== 多任务头配置 ==========
  heads:
    perception:
      type: MultiTaskDETRHead
      
      # 类别数
      num_classes: ${num_classes}
      num_seg_classes: ${num_seg_classes}
      
      # 通道数
      in_channels: 256
      
      # Query数量
      num_query_det: 900      # 检测query
      num_query_seg: 100      # 分割query
      num_reg_fcs: 2
      
      # Transformer配置
      transformer:
        type: DeformableDetrTransformer
        num_layers: 6
        num_heads: 8
        ffn_dim: 2048
        dropout: 0.1
      
      # 跟踪配置
      with_tracking: true
      track_memory_len: 5     # 记忆5帧历史
      
      # ========== 损失函数 ==========
      # 检测损失
      loss_cls:
        type: FocalLoss
        use_sigmoid: true
        gamma: 2.0
        alpha: 0.25
        loss_weight: 2.0
      
      loss_bbox:
        type: L1Loss
        loss_weight: 0.25
      
      loss_iou:
        type: GIoULoss
        loss_weight: 0.0
      
      # 分割损失
      loss_seg:
        type: CrossEntropyLoss
        use_sigmoid: false
        loss_weight: 1.0
      
      # 跟踪损失
      loss_track:
        type: TrackingLoss
        loss_weight: 0.5

# ========================================
# 数据配置
# ========================================
data_root: data/nuscenes/
data_prefix:
  sweeps: sweeps
  samples: samples

# 训练Pipeline
train_pipeline:
  - type: LoadMultiViewImageFromFiles
    to_float32: true
  - type: LoadPointsFromFile
    coord_type: LIDAR
    load_dim: ${load_dim}
    use_dim: ${use_dim}
    reduce_beams: ${reduce_beams}
    load_augmented: ${load_augmented}
  - type: LoadPointsFromMultiSweeps
    sweeps_num: 0
    load_dim: ${load_dim}
    use_dim: ${use_dim}
    reduce_beams: ${reduce_beams}
    pad_empty_sweeps: true
    remove_close: true
    load_augmented: ${load_augmented}
  - type: LoadAnnotations3D
    with_bbox_3d: true
    with_label_3d: true
    with_attr_label: false
  # 新增：加载语义地图标注
  - type: LoadBEVSegmentation
    bev_seg_root: ${data_root}/bev_seg
    seg_classes: ${num_seg_classes}
  # 新增：加载跟踪ID
  - type: LoadTrackIDs
  # ... 其他数据增强 ...
  - type: ImageAug3D
    final_dim: ${image_size}
    resize_lim: ${augment2d.resize[0]}
    bot_pct_lim: [0.0, 0.0]
    rot_lim: ${augment2d.rotate}
    rand_flip: true
    is_train: true
  - type: GlobalRotScaleTrans
    resize_lim: ${augment3d.scale}
    rot_lim: ${augment3d.rotate}
    trans_lim: ${augment3d.translate}
    is_train: true
  - type: RandomFlip3D
  - type: PointsRangeFilter
    point_cloud_range: ${point_cloud_range}
  - type: ObjectRangeFilter
    point_cloud_range: ${point_cloud_range}
  - type: ObjectNameFilter
    classes: ${object_classes}
  - type: ImageNormalize
    mean: [0.485, 0.456, 0.406]
    std: [0.229, 0.224, 0.225]
  - type: GridMask
    use_h: true
    use_w: true
    max_epoch: ${max_epochs}
    rotate: 1
    offset: false
    ratio: 0.5
    mode: 1
    prob: ${augment2d.gridmask.prob}
    fixed_prob: ${augment2d.gridmask.fixed_prob}
  - type: PointShuffle
  - type: DefaultFormatBundle3D
    classes: ${object_classes}
  - type: Collect3D
    keys:
      - img
      - points
      - gt_bboxes_3d
      - gt_labels_3d
      - gt_seg_masks      # 语义地图GT
      - gt_track_ids      # 跟踪ID GT
    meta_keys:
      - camera_intrinsics
      - camera2ego
      - lidar2ego
      - lidar2camera
      - lidar2image
      - camera2lidar
      - img_aug_matrix
      - lidar_aug_matrix
      - scene_token       # 场景标识（用于跟踪）
      - timestamp         # 时间戳
  - type: GTDepth
    keyframe_only: true

# ========================================
# 训练配置
# ========================================
optimizer:
  type: AdamW
  lr: 2.0e-4
  weight_decay: 0.01
  paramwise_cfg:
    custom_keys:
      absolute_pos_embed:
        decay_mult: 0
      relative_position_bias_table:
        decay_mult: 0

optimizer_config:
  grad_clip:
    max_norm: 35
    norm_type: 2

lr_config:
  policy: CosineAnnealing
  warmup: linear
  warmup_iters: 500
  warmup_ratio: 0.33333333
  min_lr_ratio: 1.0e-3

momentum_config: null

# 训练周期
max_epochs: 24
evaluation:
  interval: 1

# Checkpoint配置
checkpoint_config:
  interval: 1
  max_keep_ckpts: 3

# 日志配置
log_config:
  interval: 50
  hooks:
    - type: TextLoggerHook
    - type: TensorboardLoggerHook

# Runtime配置
runner:
  type: CustomEpochBasedRunner
  max_epochs: ${max_epochs}

# 分布式训练
dist_params:
  backend: nccl

# 工作目录
work_dir: work_dirs/bevfusion_e2e_perception

# 随机种子
seed: 0
deterministic: false

# GPU设置
gpu_ids: [0]

# ========================================
# 评估配置
# ========================================
evaluation_config:
  # 检测评估
  detection:
    metrics: ['bbox', 'NDS', 'mAP']
    interval: 1
  
  # 分割评估
  segmentation:
    metrics: ['mIoU', 'mAcc']
    interval: 1
  
  # 跟踪评估
  tracking:
    metrics: ['MOTA', 'IDF1', 'MOTP']
    interval: 1
